{% extends "base.html" %}

{% block title %}Dashboard - DVD to Plex{% endblock %}

{% block content %}
<h1 class="mb-3">Dashboard</h1>

<!-- Active Mode Card -->
<div class="card mb-3">
    <div class="card-header">
        <span class="card-title">Active Mode</span>
    </div>
    <div class="card-body">
        <div class="toggle-container" data-active="{% if active_mode %}true{% else %}false{% endif %}">
            <label class="toggle btn-toggle">
                <input type="checkbox" id="active-mode-toggle" {% if active_mode %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Automatic Processing</span>
            <span id="active-mode-state" class="toggle-state {% if active_mode %}on{% else %}off{% endif %}">
                {% if active_mode %}ON{% else %}OFF{% endif %}
            </span>
        </div>
        <p class="text-muted" style="margin-top: 0.75rem; font-size: 0.9rem;">
            {% if active_mode %}
                System is actively monitoring drives and processing DVDs.
            {% else %}
                System is paused. Toggle on to resume automatic processing.
            {% endif %}
        </p>
    </div>
</div>

<!-- Mode Selector Card -->
<div class="card mb-3">
    <div class="card-header">
        <span class="card-title">Ripping Mode</span>
    </div>
    <div class="card-body">
        <div class="mode-selector" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="btn mode-btn {% if current_mode == 'movie' %}btn-primary{% else %}btn-secondary{% endif %}"
                    onclick="setMode('movie')" data-mode="movie">
                Movie
            </button>
            <button class="btn mode-btn {% if current_mode == 'tv' %}btn-primary{% else %}btn-secondary{% endif %}"
                    onclick="setMode('tv')" data-mode="tv">
                TV Show
            </button>
            <button class="btn mode-btn {% if current_mode == 'home_movies' %}btn-primary{% else %}btn-secondary{% endif %}"
                    onclick="setMode('home_movies')" data-mode="home_movies">
                Home Movies
            </button>
            <button class="btn mode-btn {% if current_mode == 'other' %}btn-primary{% else %}btn-secondary{% endif %}"
                    onclick="setMode('other')" data-mode="other">
                Other
            </button>
        </div>
        <p class="text-muted" style="margin-top: 0.75rem; font-size: 0.9rem;">
            <span id="mode-description">
                {% if current_mode == 'movie' %}
                Movies: TMDb search, saves to Movies folder
                {% elif current_mode == 'tv' %}
                TV: TMDb TV search, saves to TV Shows folder
                {% elif current_mode == 'home_movies' %}
                Home Movies: No TMDb, uses disc label, saves to Home Movies folder
                {% else %}
                Other: No TMDb, uses disc label, saves to Other folder
                {% endif %}
            </span>
        </p>
    </div>
</div>

<!-- Oversight Warning Banner -->
<div id="oversight-warning" class="card mb-3" style="display: none; border-color: #f0ad4e; background-color: #fcf8e3;">
    <div class="card-header" style="background-color: #f0ad4e; color: #8a6d3b;">
        <span class="card-title">State Issues Detected</span>
    </div>
    <div class="card-body">
        <ul id="oversight-issues" style="margin: 0 0 1rem 0; padding-left: 1.5rem; color: #8a6d3b;"></ul>
        <button class="btn btn-primary" onclick="fixEncodingIssues()">Auto-Fix Encoding Issues</button>
    </div>
</div>

<!-- Drive Status Cards -->
<div class="grid-2 mb-3">
    {% for drive in drives %}
    <div class="card">
        <div class="card-header">
            <span class="card-title">
                <span class="drive-indicator {% if drive.processing %}processing{% elif drive.has_disc %}has-disc{% else %}empty{% endif %}"></span>
                {{ drive.name or 'Unknown Drive' }}
            </span>
        </div>
        <div class="card-body">
            {% if drive.has_disc %}
                <p><strong>Disc:</strong> {{ drive.disc_label or 'Unknown Disc' }}</p>
                {% if drive.status %}
                    <p><strong>Status:</strong> <span class="status status-{{ drive.status|lower }}">{{ drive.status }}</span></p>
                {% endif %}
            {% else %}
                <p class="text-muted">No disc inserted</p>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="card">
        <div class="card-body">
            <p class="text-muted">No DVD drives detected</p>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Recent Jobs Table -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Recent Jobs</span>
    </div>
    <div class="card-body" style="padding: 0;">
        <table>
            <thead>
                <tr>
                    <th>Disc Label</th>
                    <th>Status</th>
                    <th>Size</th>
                    <th>Identified As</th>
                    <th>Updated</th>
                    <th style="width: 60px;"></th>
                </tr>
            </thead>
            <tbody>
                {% for job in recent_jobs %}
                <tr data-job-id="{{ job.id }}">
                    <td>{{ job.disc_label }}</td>
                    <td><span class="status status-{{ job.status|lower }}">{{ job.status }}</span></td>
                    <td class="text-muted">{{ job.file_size or '--' }}</td>
                    <td>
                        {% if job.identified_title %}
                            {{ job.identified_title }}
                            {% if job.identified_year %}({{ job.identified_year }}){% endif %}
                            {% if job.content_type == 'movie' %}
                                <span class="badge badge-movie">Movie</span>
                            {% elif job.content_type == 'tv_season' %}
                                <span class="badge badge-tv">TV</span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Not identified</span>
                        {% endif %}
                    </td>
                    <td class="text-muted">{{ job.updated_at }}</td>
                    <td>
                        {% if job.status in ['pending', 'ripping', 'ripped', 'encoding', 'encoded'] and not job.identified_title %}
                        <button class="btn btn-sm btn-primary" onclick="identifyJob({{ job.id }}, '{{ job.disc_label|replace("'", "\\'")|e }}')" title="Identify">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                            </svg>
                        </button>
                        {% elif job.status in ['complete', 'failed'] %}
                        <button class="btn btn-sm btn-secondary" onclick="archiveJob({{ job.id }})" title="Archive">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M0 2a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1v7.5a2.5 2.5 0 0 1-2.5 2.5h-9A2.5 2.5 0 0 1 1 12.5V5a1 1 0 0 1-1-1V2zm2 3v7.5A1.5 1.5 0 0 0 3.5 14h9a1.5 1.5 0 0 0 1.5-1.5V5H2zm13-3H1v2h14V2zM5 7.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                            </svg>
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-muted" style="text-align: center;">No jobs yet</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function checkOversight() {
        try {
            const response = await fetch('/api/oversight/check');
            const data = await response.json();

            if (data.count > 0) {
                const warningDiv = document.getElementById('oversight-warning');
                const issuesList = document.getElementById('oversight-issues');

                // Clear existing issues
                issuesList.innerHTML = '';

                // Add each issue as a list item
                data.issues.forEach(function(issue) {
                    const li = document.createElement('li');
                    li.textContent = issue;
                    issuesList.appendChild(li);
                });

                // Show the warning banner
                warningDiv.style.display = 'block';
            }
        } catch (error) {
            console.error('Error checking oversight:', error);
        }
    }

    async function fixEncodingIssues() {
        try {
            const response = await fetch('/api/oversight/fix-encoding', {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                alert('Fixed ' + data.fixed_count + ' encoding job(s). Reloading...');
                window.location.reload();
            } else {
                alert(data.detail || 'Failed to fix encoding issues');
            }
        } catch (error) {
            console.error('Error fixing encoding issues:', error);
            alert('Failed to fix encoding issues');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Check for oversight issues on page load
        checkOversight();

        const toggle = document.getElementById('active-mode-toggle');
        const stateLabel = document.getElementById('active-mode-state');

        toggle.addEventListener('change', async function() {
            const newState = this.checked;

            try {
                const response = await fetch('/api/active-mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ active_mode: newState })
                });

                const result = await response.json();

                if (result.success) {
                    // Update the UI to reflect the new state
                    if (result.active_mode) {
                        stateLabel.textContent = 'ON';
                        stateLabel.classList.remove('off');
                        stateLabel.classList.add('on');
                    } else {
                        stateLabel.textContent = 'OFF';
                        stateLabel.classList.remove('on');
                        stateLabel.classList.add('off');
                    }
                    // Reload to update the description text
                    window.location.reload();
                } else {
                    // Revert toggle if failed
                    toggle.checked = !newState;
                    alert('Failed to update active mode');
                }
            } catch (error) {
                // Revert toggle on error
                toggle.checked = !newState;
                console.error('Error updating active mode:', error);
                alert('Error updating active mode');
            }
        });
    });

    async function archiveJob(jobId) {
        try {
            const response = await fetch(`/api/jobs/${jobId}/archive`, {
                method: 'POST',
            });

            if (response.ok) {
                // Remove the row from the table
                const row = document.querySelector(`tr[data-job-id="${jobId}"]`);
                if (row) {
                    row.remove();
                }
            } else {
                const data = await response.json();
                alert(data.detail || 'Failed to archive job');
            }
        } catch (error) {
            console.error('Error archiving job:', error);
            alert('Failed to archive job');
        }
    }

    async function setMode(mode) {
        try {
            const response = await fetch('/api/mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode: mode }),
            });

            if (response.ok) {
                // Update button states
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-secondary');
                });
                document.querySelector(`[data-mode="${mode}"]`).classList.remove('btn-secondary');
                document.querySelector(`[data-mode="${mode}"]`).classList.add('btn-primary');

                // Update description
                const descriptions = {
                    'movie': 'Movies: TMDb search, saves to Movies folder',
                    'tv': 'TV: TMDb TV search, saves to TV Shows folder',
                    'home_movies': 'Home Movies: No TMDb, uses disc label, saves to Home Movies folder',
                    'other': 'Other: No TMDb, uses disc label, saves to Other folder'
                };
                document.getElementById('mode-description').textContent = descriptions[mode];
            } else {
                const data = await response.json();
                alert(data.detail || 'Failed to set mode');
            }
        } catch (error) {
            console.error('Error setting mode:', error);
            alert('Failed to set mode');
        }
    }

    async function identifyJob(jobId, discLabel) {
        // Pre-fill title with disc label, replacing underscores with spaces
        const defaultTitle = discLabel.replace(/_/g, ' ');

        const title = prompt('Enter the title:', defaultTitle);
        if (title === null) {
            // User cancelled
            return;
        }

        if (!title.trim()) {
            alert('Title is required');
            return;
        }

        const yearInput = prompt('Enter the year (optional):');
        // User cancelled on year prompt
        if (yearInput === null) {
            return;
        }

        const year = yearInput.trim() ? parseInt(yearInput.trim(), 10) : null;

        // Validate year if provided
        if (year !== null && (isNaN(year) || year < 1800 || year > 2100)) {
            alert('Please enter a valid year (1800-2100)');
            return;
        }

        try {
            const response = await fetch(`/api/jobs/${jobId}/pre-identify`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ title: title.trim(), year: year })
            });

            if (response.ok) {
                window.location.reload();
            } else {
                const data = await response.json();
                alert(data.detail || 'Failed to identify job');
            }
        } catch (error) {
            console.error('Error identifying job:', error);
            alert('Failed to identify job');
        }
    }
</script>
{% endblock %}
